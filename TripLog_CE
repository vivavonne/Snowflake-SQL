SET VAR_START_DATE = '01-JAN-2021';
SET VAR_END_DATE = '07-OCT-2021';


(select 
'C1' AS CLUSTER_LOCATION
, R.RECEIPT_FILENAME AS FILENAME
, P.EMP_PK AS EMPID
, CONCAT(U.USR_FNAME,' ',U.USR_LNAME) AS USERNAME
, R.RECEIPT_PK AS RECEIPTNBR
, MIN(E.EXP_DATE) AS MINDATE
, MAX(E.EXP_DATE) AS MAXDATE
, E.EXP_AMOUNT
, C. COMPANY_NAME
, M.EXPCATMILEAGE_MILES

from "BRONZE_CE"."CE_PROD_01_DBO"."RECEIPT" R
JOIN "BRONZE_CE"."CE_PROD_01_DBO"."EXP" E ON E.EXP_RECEIPTFK = R.RECEIPT_PK
JOIN "BRONZE_CE"."CE_PROD_01_DBO"."EMP" P ON P.EMP_PK = E.EXP_EMPFK
JOIN "BRONZE_CE"."CE_PROD_01_DBO"."COMPANY" C ON C.COMPANY_PK = P.EMP_COMPANYFK
JOIN "BRONZE_CE"."CE_PROD_01_DBO"."USR" U ON U.USR_PK = P.EMP_USRFK
JOIN "BRONZE_CE"."CE_PROD_01_DBO"."EXPCATMILEAGE" M ON M.EXPCATMILEAGE_EXPFK = E.EXP_PK

where RECEIPT_RECEIPTINPUTSOURCEFK = 1
and RECEIPT_FILENAME like '%triplog%'
AND EXP_DATE>= $var_start_date and EXP_DATE<= $var_end_date
AND R._FIVETRAN_DELETED = FALSE AND E._FIVETRAN_DELETED= FALSE AND P._FIVETRAN_DELETED=FALSE AND C._FIVETRAN_DELETED=FALSE
and  P.EMP_PK  not in ('71966','71962','617327')
GROUP BY FILENAME, RECEIPTNBR,EMPID,USERNAME,E.EXP_DATE
, E.EXP_AMOUNT
, C. COMPANY_NAME,M.EXPCATMILEAGE_MILES)

UNION ALL

(select 
'C2' AS CLUSTER_LOCATION
, R.RECEIPT_FILENAME AS FILENAME
, P.EMP_PK AS EMPID
, CONCAT(U.USR_FNAME,' ',U.USR_LNAME) AS USERNAME
, R.RECEIPT_PK AS RECEIPTNBR
, MIN(E.EXP_DATE) AS MINDATE
, MAX(E.EXP_DATE) AS MAXDATE
, E.EXP_AMOUNT
, C. COMPANY_NAME
, M.EXPCATMILEAGE_MILES

from "BRONZE_CE"."CE_PROD_02_DBO"."RECEIPT" R
JOIN "BRONZE_CE"."CE_PROD_02_DBO"."EXP" E ON E.EXP_RECEIPTFK = R.RECEIPT_PK
JOIN "BRONZE_CE"."CE_PROD_02_DBO"."EMP" P ON P.EMP_PK = E.EXP_EMPFK
JOIN "BRONZE_CE"."CE_PROD_02_DBO"."COMPANY" C ON C.COMPANY_PK = P.EMP_COMPANYFK
JOIN "BRONZE_CE"."CE_PROD_02_DBO"."USR" U ON U.USR_PK = P.EMP_USRFK
JOIN "BRONZE_CE"."CE_PROD_02_DBO"."EXPCATMILEAGE" M ON M.EXPCATMILEAGE_EXPFK = E.EXP_PK

where RECEIPT_RECEIPTINPUTSOURCEFK = 1
and RECEIPT_FILENAME like '%triplog%'
AND EXP_DATE>= $var_start_date and EXP_DATE<= $var_end_date
AND R._FIVETRAN_DELETED = FALSE AND E._FIVETRAN_DELETED= FALSE AND P._FIVETRAN_DELETED=FALSE AND C._FIVETRAN_DELETED=FALSE
and  P.EMP_PK  not in ('71966','71962','617327')
GROUP BY FILENAME, RECEIPTNBR,EMPID,USERNAME,E.EXP_DATE
, E.EXP_AMOUNT
, C. COMPANY_NAME,M.EXPCATMILEAGE_MILES)

UNION ALL

(select 
'C3' AS CLUSTER_LOCATION
, R.RECEIPT_FILENAME AS FILENAME
, P.EMP_PK AS EMPID
, CONCAT(U.USR_FNAME,' ',U.USR_LNAME) AS USERNAME
, R.RECEIPT_PK AS RECEIPTNBR
, MIN(E.EXP_DATE) AS MINDATE
, MAX(E.EXP_DATE) AS MAXDATE
, E.EXP_AMOUNT
, C. COMPANY_NAME
, M.EXPCATMILEAGE_MILES

from "BRONZE_CE"."CE_PROD_03_DBO"."RECEIPT" R
JOIN "BRONZE_CE"."CE_PROD_03_DBO"."EXP" E ON E.EXP_RECEIPTFK = R.RECEIPT_PK
JOIN "BRONZE_CE"."CE_PROD_03_DBO"."EMP" P ON P.EMP_PK = E.EXP_EMPFK
JOIN "BRONZE_CE"."CE_PROD_03_DBO"."COMPANY" C ON C.COMPANY_PK = P.EMP_COMPANYFK
JOIN "BRONZE_CE"."CE_PROD_03_DBO"."USR" U ON U.USR_PK = P.EMP_USRFK
JOIN "BRONZE_CE"."CE_PROD_03_DBO"."EXPCATMILEAGE" M ON M.EXPCATMILEAGE_EXPFK = E.EXP_PK

where RECEIPT_RECEIPTINPUTSOURCEFK = 1
and RECEIPT_FILENAME like '%triplog%'
AND EXP_DATE>= $var_start_date and EXP_DATE<= $var_end_date
AND R._FIVETRAN_DELETED = FALSE AND E._FIVETRAN_DELETED= FALSE AND P._FIVETRAN_DELETED=FALSE AND C._FIVETRAN_DELETED=FALSE
and  P.EMP_PK  not in ('71966','71962','617327')
GROUP BY FILENAME, RECEIPTNBR,EMPID,USERNAME,E.EXP_DATE
, E.EXP_AMOUNT
, C. COMPANY_NAME,M.EXPCATMILEAGE_MILES)

UNION ALL


(select 
'C4' AS CLUSTER_LOCATION
, R.RECEIPT_FILENAME AS FILENAME
, P.EMP_PK AS EMPID
, CONCAT(U.USR_FNAME,' ',U.USR_LNAME) AS USERNAME
, R.RECEIPT_PK AS RECEIPTNBR
, MIN(E.EXP_DATE) AS MINDATE
, MAX(E.EXP_DATE) AS MAXDATE
, E.EXP_AMOUNT
, C. COMPANY_NAME
, M.EXPCATMILEAGE_MILES

from "BRONZE_CE"."CE_PROD_04_DBO"."RECEIPT" R
JOIN "BRONZE_CE"."CE_PROD_04_DBO"."EXP" E ON E.EXP_RECEIPTFK = R.RECEIPT_PK
JOIN "BRONZE_CE"."CE_PROD_04_DBO"."EMP" P ON P.EMP_PK = E.EXP_EMPFK
JOIN "BRONZE_CE"."CE_PROD_04_DBO"."COMPANY" C ON C.COMPANY_PK = P.EMP_COMPANYFK
JOIN "BRONZE_CE"."CE_PROD_04_DBO"."USR" U ON U.USR_PK = P.EMP_USRFK
JOIN "BRONZE_CE"."CE_PROD_04_DBO"."EXPCATMILEAGE" M ON M.EXPCATMILEAGE_EXPFK = E.EXP_PK

where RECEIPT_RECEIPTINPUTSOURCEFK = 1
and RECEIPT_FILENAME like '%triplog%'
AND EXP_DATE>= $var_start_date and EXP_DATE<= $var_end_date
AND R._FIVETRAN_DELETED = FALSE AND E._FIVETRAN_DELETED= FALSE AND P._FIVETRAN_DELETED=FALSE AND C._FIVETRAN_DELETED=FALSE
and  P.EMP_PK  not in ('71966','71962','617327')
GROUP BY FILENAME, RECEIPTNBR,EMPID,USERNAME,E.EXP_DATE
, E.EXP_AMOUNT
, C. COMPANY_NAME,M.EXPCATMILEAGE_MILES)
