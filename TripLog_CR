SET VAR_START_DATE = '01-JAN-2021';
SET VAR_END_DATE = '07-OCT-2021';


(select DISTINCT
'C1' AS CLUSTER_LOCATION
, COUNT (H.EXPENSEREPORTHEADERID) AS REPORTS
, H.PERSONID
, concat(P.FIRSTNAME,' ', P.LASTNAME) as USER_NAME
, H.CUSTOMERID
, C.NAME as CUSTOMER_NAME
, MIN(l.TRANSACTIONDATE) as MINTRANSDATE
, MAX(l.TRANSACTIONDATE) AS MAXTRANSDATE
, LT.MILES
, H.SUBMITDATE
, F.FEEDID
, F.NAME 
 
from "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTHEADER" H 
join "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_PERSON" P on P.PERSONID = H.PERSONID
join "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_CUSTOMER" C on C.CUSTOMERID = H.CUSTOMERID
join "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTLINEITEM" L ON H.EXPENSEREPORTHEADERID = L.EXPENSEREPORTHEADERID
JOIN "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTLINEITEMTRIP" LT ON LT.EXPENSEREPORTLINEITEMID = L.EXPENSEREPORTLINEITEMID
,"BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_FEED" F 
,"BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_FEEDTYPE" FT 
 
where 
 l.TRANSACTIONDATE>= $var_start_date and l.TRANSACTIONDATE <= $var_end_date
and H._FIVETRAN_DELETED = FALSE and P._FIVETRAN_DELETED = FALSE and C._FIVETRAN_DELETED = FALSE AND F._FIVETRAN_DELETED = FALSE AND LT._FIVETRAN_DELETED
AND P.PERSONSTATUSID = 2
and h.STATUSID IN (3,5)
AND F.FEEDID IN  (15123)


GROUP BY H.PERSONID
, P.FIRSTNAME
, P.LASTNAME
, H.CUSTOMERID
, C.NAME
, H.SUBMITDATE
, F.FEEDID
, F.NAME
, LT.MILES

HAVING LT.MILES >0

ORDER BY MIN(TRANSACTIONDATE))

UNION ALL

(select DISTINCT
'C2' AS CLUSTER_LOCATION
, COUNT (H.EXPENSEREPORTHEADERID) AS REPORTS
, H.PERSONID
, concat(P.FIRSTNAME,' ', P.LASTNAME) as USER_NAME
, H.CUSTOMERID
, C.NAME as CUSTOMER_NAME
, MIN(l.TRANSACTIONDATE) as MINTRANSDATE
, MAX(l.TRANSACTIONDATE) AS MAXTRANSDATE
, LT.MILES
, H.SUBMITDATE
, F.FEEDID
, F.NAME 
 
from "BRONZE_CR"."CR_C2_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTHEADER" H 
join "BRONZE_CR"."CR_C2_PROD_CHROME_EXPENSE"."TBL_PERSON" P on P.PERSONID = H.PERSONID
join "BRONZE_CR"."CR_C2_PROD_CHROME_EXPENSE"."TBL_CUSTOMER" C on C.CUSTOMERID = H.CUSTOMERID
join "BRONZE_CR"."CR_C2_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTLINEITEM" L ON H.EXPENSEREPORTHEADERID = L.EXPENSEREPORTHEADERID
JOIN "BRONZE_CR"."CR_C2_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTLINEITEMTRIP" LT ON LT.EXPENSEREPORTLINEITEMID = L.EXPENSEREPORTLINEITEMID
,"BRONZE_CR"."CR_C2_PROD_CHROME_EXPENSE"."TBL_FEED" F 
 
where 
  l.TRANSACTIONDATE>= $var_start_date and l.TRANSACTIONDATE <= $var_end_date
and H._FIVETRAN_DELETED = FALSE and P._FIVETRAN_DELETED = FALSE and C._FIVETRAN_DELETED = FALSE AND F._FIVETRAN_DELETED = FALSE AND LT._FIVETRAN_DELETED
AND P.PERSONSTATUSID = 2
and h.STATUSID IN (3,5)
AND F.FEEDID IN  (15123)


GROUP BY H.PERSONID
, P.FIRSTNAME
, P.LASTNAME
, H.CUSTOMERID
, C.NAME
, H.SUBMITDATE
, F.FEEDID
, F.NAME
, LT.MILES

HAVING LT.MILES >0

ORDER BY MIN(TRANSACTIONDATE))

UNION ALL

(select DISTINCT
'C7' AS CLUSTER_LOCATION
, COUNT (H.EXPENSEREPORTHEADERID) AS REPORTS
, H.PERSONID
, concat(P.FIRSTNAME,' ', P.LASTNAME) as USER_NAME
, H.CUSTOMERID
, C.NAME as CUSTOMER_NAME
, MIN(L.TRANSACTIONDATE) as MINTRANSDATE
, MAX(L.TRANSACTIONDATE) AS MAXTRANSDATE
, LT.MILES
, H.SUBMITDATE
, F.FEEDID
, F.NAME 
 
from "BRONZE_CR"."CR_C7_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTHEADER" H 
join "BRONZE_CR"."CR_C7_PROD_CHROME_EXPENSE"."TBL_PERSON" P on P.PERSONID = H.PERSONID
join "BRONZE_CR"."CR_C7_PROD_CHROME_EXPENSE"."TBL_CUSTOMER" C on C.CUSTOMERID = H.CUSTOMERID
join "BRONZE_CR"."CR_C7_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTLINEITEM" L ON H.EXPENSEREPORTHEADERID = L.EXPENSEREPORTHEADERID
JOIN "BRONZE_CR"."CR_C7_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTLINEITEMTRIP" LT ON LT.EXPENSEREPORTLINEITEMID = L.EXPENSEREPORTLINEITEMID
,"BRONZE_CR"."CR_C7_PROD_CHROME_EXPENSE"."TBL_FEED" F
where 
 l.TRANSACTIONDATE>= $var_start_date and l.TRANSACTIONDATE <= $var_end_date
and H._FIVETRAN_DELETED = FALSE and P._FIVETRAN_DELETED = FALSE and C._FIVETRAN_DELETED = FALSE AND F._FIVETRAN_DELETED = FALSE AND LT._FIVETRAN_DELETED
AND P.PERSONSTATUSID = 2
and h.STATUSID IN (3,5)
AND F.FEEDID IN  (15123)

GROUP BY H.PERSONID
, P.FIRSTNAME
, P.LASTNAME
, H.CUSTOMERID
, C.NAME
, H.SUBMITDATE
, F.FEEDID
, F.NAME
, LT.MILES

HAVING LT.MILES >0

ORDER BY MIN(L.TRANSACTIONDATE))
