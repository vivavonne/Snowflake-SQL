SET VAR_START_DATE = '01-JAN-2021';
SET VAR_END_DATE = '31-AUG-2021';

SELECT MONTH, COUNT( LINEITEMCOUNT) FROM 

((select 
  C.NAME as CUSTOMER_NAME
, COUNT( DISTINCT L.EXPENSEREPORTLINEITEMID) AS LINEITEMCOUNT
, MONTH(L.TRANSACTIONDATE) AS MONTH
, F.NAME
, L.ISPARENT
 
from "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTHEADER" H 
join "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_PERSON" P on P.PERSONID = H.PERSONID
join "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_CUSTOMER" C on C.CUSTOMERID = H.CUSTOMERID
join "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTLINEITEM" L ON H.EXPENSEREPORTHEADERID = L.EXPENSEREPORTHEADERID
,"BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_FEED" F 
,"BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_FEEDTYPE" FT 
 
where 
 l.TRANSACTIONDATE>= $var_start_date and l.TRANSACTIONDATE <= $var_end_date
and H._FIVETRAN_DELETED = FALSE and P._FIVETRAN_DELETED = FALSE and C._FIVETRAN_DELETED = FALSE AND F._FIVETRAN_DELETED = FALSE 
AND P.PERSONSTATUSID = 2
and h.STATUSID IN (3,5)
AND LOWER(F.NAME) LIKE '%traxo%'
AND C.CUSTOMERID = 624
AND L.ISPARENT = 1
AND EXPENSEREPORTITEMTYPEID =73405 
GROUP BY 
 C.NAME
, F.NAME
, H.SUBMITDATE
, MONTH
, L.ISPARENT
ORDER BY MONTH
)

UNION ALL
 
(select 
  C.NAME as CUSTOMER_NAME
, COUNT( DISTINCT L.EXPENSEREPORTLINEITEMID) AS LINEITEMCOUNT
, MONTH(L.TRANSACTIONDATE) AS MONTH
, F.NAME
, L.ISPARENT
 
from "BRONZE_CR"."CR_C2_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTHEADER" H 
join "BRONZE_CR"."CR_C2_PROD_CHROME_EXPENSE"."TBL_PERSON" P on P.PERSONID = H.PERSONID
join "BRONZE_CR"."CR_C2_PROD_CHROME_EXPENSE"."TBL_CUSTOMER" C on C.CUSTOMERID = H.CUSTOMERID
join "BRONZE_CR"."CR_C2_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTLINEITEM" L ON H.EXPENSEREPORTHEADERID = L.EXPENSEREPORTHEADERID
,"BRONZE_CR"."CR_C2_PROD_CHROME_EXPENSE"."TBL_FEED" F 
,"BRONZE_CR"."CR_C2_PROD_CHROME_EXPENSE"."TBL_FEEDTYPE" FT 
 
where 
 l.TRANSACTIONDATE>= $var_start_date and l.TRANSACTIONDATE <= $var_end_date
and H._FIVETRAN_DELETED = FALSE and P._FIVETRAN_DELETED = FALSE and C._FIVETRAN_DELETED = FALSE AND F._FIVETRAN_DELETED = FALSE 
AND P.PERSONSTATUSID = 2
and h.STATUSID IN (3,5)
AND LOWER(F.NAME) LIKE '%traxo%'
AND C.CUSTOMERID = 624
AND L.ISPARENT = 1
AND EXPENSEREPORTITEMTYPEID =73405
GROUP BY 
 C.NAME
, F.NAME
, H.SUBMITDATE
, MONTH
, L.ISPARENT
ORDER BY MONTH
)

 UNION ALL
 
 (select 
  C.NAME as CUSTOMER_NAME
, COUNT( DISTINCT L.EXPENSEREPORTLINEITEMID) AS LINEITEMCOUNT
, MONTH(L.TRANSACTIONDATE) AS MONTH
, F.NAME
, L.ISPARENT
 
from "BRONZE_CR"."CR_C7_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTHEADER" H 
join "BRONZE_CR"."CR_C7_PROD_CHROME_EXPENSE"."TBL_PERSON" P on P.PERSONID = H.PERSONID
join "BRONZE_CR"."CR_C7_PROD_CHROME_EXPENSE"."TBL_CUSTOMER" C on C.CUSTOMERID = H.CUSTOMERID
join "BRONZE_CR"."CR_C7_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTLINEITEM" L ON H.EXPENSEREPORTHEADERID = L.EXPENSEREPORTHEADERID
,"BRONZE_CR"."CR_C7_PROD_CHROME_EXPENSE"."TBL_FEED" F 
,"BRONZE_CR"."CR_C7_PROD_CHROME_EXPENSE"."TBL_FEEDTYPE" FT 
 
where 
 l.TRANSACTIONDATE>= $var_start_date and l.TRANSACTIONDATE <= $var_end_date
and H._FIVETRAN_DELETED = FALSE and P._FIVETRAN_DELETED = FALSE and C._FIVETRAN_DELETED = FALSE AND F._FIVETRAN_DELETED = FALSE 
AND P.PERSONSTATUSID = 2
and h.STATUSID IN (3,5)
AND LOWER(F.NAME) LIKE '%traxo%'
AND C.CUSTOMERID = 624
AND L.ISPARENT = 1
AND EXPENSEREPORTITEMTYPEID =73405
GROUP BY 
 C.NAME
, F.NAME
, H.SUBMITDATE
, MONTH
, L.ISPARENT
ORDER BY MONTH
)


) GROUP BY MONTH ORDER BY MONTH
