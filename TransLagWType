SET VAR_START_DATE ='01-JAN-2019';
SET VAR_END_DATE = '31-DEC-2019';

SELECT YEAR, TRANSACTION_TYPE, AVG(DATE_DIFF) FROM 
((SELECT 
YEAR (T.CREATEDATE) AS YEAR
, T.TYPE AS TRANSACTION_TYPE
, AVG (DATEDIFF(DAY,T.CREATEDATE, H.SUBMITDATE) +1)  AS DATE_DIFF

FROM "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTHEADER" H
, "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTLINEITEM" L
, "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_EXPENSETRANSACTION"  T 

WHERE H.EXPENSEREPORTHEADERID = L.EXPENSEREPORTHEADERID
AND L.EXPENSETRANSACTIONID = T.EXPENSETRANSACTIONID
AND T.CREATEDATE>= $var_start_date and T.CREATEDATE<= $var_end_date
AND H._FIVETRAN_DELETED = 'FALSE' AND L._FIVETRAN_DELETED = 'FALSE' AND T._FIVETRAN_DELETED = 'FALSE'

GROUP BY YEAR,TRANSACTION_TYPE
ORDER BY YEAR
)

UNION ALL

(SELECT 
YEAR (T.CREATEDATE) AS YEAR
, T.TYPE AS TRANSACTION_TYPE
, AVG (DATEDIFF(DAY,T.CREATEDATE, H.SUBMITDATE) +1)  AS DATE_DIFF

FROM "BRONZE_CR"."CR_C2_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTHEADER" H
, "BRONZE_CR"."CR_C2_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTLINEITEM" L
, "BRONZE_CR"."CR_C2_PROD_CHROME_EXPENSE"."TBL_EXPENSETRANSACTION"  T 

WHERE H.EXPENSEREPORTHEADERID = L.EXPENSEREPORTHEADERID
AND L.EXPENSETRANSACTIONID = T.EXPENSETRANSACTIONID
AND T.CREATEDATE>= $var_start_date and T.CREATEDATE<= $var_end_date
AND H._FIVETRAN_DELETED = 'FALSE' AND L._FIVETRAN_DELETED = 'FALSE' AND T._FIVETRAN_DELETED = 'FALSE'

GROUP BY YEAR,TRANSACTION_TYPE
ORDER BY YEAR
)

UNION ALL 

(SELECT 
YEAR (T.CREATEDATE) AS YEAR
, T.TYPE AS TRANSACTION_TYPE
, AVG (DATEDIFF(DAY,T.CREATEDATE, H.SUBMITDATE) +1)  AS DATE_DIFF

FROM "BRONZE_CR"."CR_C7_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTHEADER" H
, "BRONZE_CR"."CR_C7_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTLINEITEM" L
, "BRONZE_CR"."CR_C7_PROD_CHROME_EXPENSE"."TBL_EXPENSETRANSACTION"  T 

WHERE H.EXPENSEREPORTHEADERID = L.EXPENSEREPORTHEADERID
AND L.EXPENSETRANSACTIONID = T.EXPENSETRANSACTIONID
AND T.CREATEDATE>= $var_start_date and T.CREATEDATE<= $var_end_date
AND H._FIVETRAN_DELETED = 'FALSE' AND L._FIVETRAN_DELETED = 'FALSE' AND T._FIVETRAN_DELETED = 'FALSE'

GROUP BY YEAR,TRANSACTION_TYPE
ORDER BY YEAR
))
GROUP BY YEAR,TRANSACTION_TYPE
ORDER BY YEAR
