//grabs invoices and vendor countries

SET VAR_START_DATE ='01-JAN-2021';
SET VAR_END_DATE = GETDATE();

CREATE OR REPLACE TABLE "JBML"."PUBLIC"."INVOICE_PRACTICE" AS



SELECT MONTH, CUSTOMER_COUNTRY,VENDOR_COUNTRY,HEADER_ID_COUNT,INVOICE_AMOUNT FROM

((SELECT 
MONTHNAME(I.INVOICEDATE) AS MONTH
,I.INVOICEHEADERID
, CASE WHEN C.COUNTRY = '' THEN 'NULL' ELSE C.COUNTRY END AS CUSTOMER_COUNTRY
, CASE WHEN V.COUNTRY = '' THEN 'NULL' ELSE V.COUNTRY END AS VENDOR_COUNTRY
, count(I.INVOICEHEADERID) AS HEADER_ID_COUNT
, SUM(I.AMOUNTCUSTOMER) AS INVOICE_AMOUNT
  
FROM "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_INVOICEHEADER" I
, "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_INVOICEVENDORADDRESS" V
, "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_CUSTOMERADDRESS" C

WHERE I.INVOICEVENDORADDRESSID = V.VENDORADDRESSID
AND I.CUSTOMERADDRESSID1 = C.CUSTOMERADDRESSID
AND I.INVOICEDATE>= $var_start_date and I.INVOICEDATE<= $var_end_date
--AND I.HEADERSTATUS <> 'DEL'
--AND C.STATUS <>'DEL'
AND I._FIVETRAN_DELETED ='FALSE' 
AND LOWER(C.CITY)  NOT LIKE '%test%'
--AND C.COUNTRY !='' 
--AND V.COUNTRY !=''

GROUP BY MONTH,I.INVOICEHEADERID,CUSTOMER_COUNTRY,VENDOR_COUNTRY)

UNION ALL

(SELECT 
MONTHNAME(I.INVOICEDATE) AS MONTH
,I.INVOICEHEADERID
, CASE WHEN C.COUNTRY = '' THEN 'NULL' ELSE C.COUNTRY END AS CUSTOMER_COUNTRY
, CASE WHEN V.COUNTRY = '' THEN 'NULL' ELSE V.COUNTRY END AS VENDOR_COUNTRY
, count(I.INVOICEHEADERID) AS HEADER_ID_COUNT
, I.AMOUNTCUSTOMER AS INVOICE_AMOUNT
  
FROM "BRONZE_CR"."CR_C2_PROD_CHROME_EXPENSE"."TBL_INVOICEHEADER" I
, "BRONZE_CR"."CR_C2_PROD_CHROME_EXPENSE"."TBL_INVOICEVENDORADDRESS" V
, "BRONZE_CR"."CR_C2_PROD_CHROME_EXPENSE"."TBL_CUSTOMERADDRESS" C

WHERE I.INVOICEVENDORADDRESSID = V.VENDORADDRESSID
AND I.CUSTOMERADDRESSID1 = C.CUSTOMERADDRESSID
AND I.INVOICEDATE>= $var_start_date and I.INVOICEDATE<= $var_end_date
--AND I.HEADERSTATUS <> 'DEL'
--AND C.STATUS <>'DEL'
AND I._FIVETRAN_DELETED ='FALSE' 
AND LOWER(C.CITY)  NOT LIKE '%test%'
--AND C.COUNTRY !='' 
--AND V.COUNTRY !=''

GROUP BY MONTH,I.INVOICEHEADERID,CUSTOMER_COUNTRY,VENDOR_COUNTRY,INVOICE_AMOUNT)
 
UNION ALL
 
(SELECT 
MONTHNAME(I.INVOICEDATE) AS MONTH
,I.INVOICEHEADERID
, CASE WHEN C.COUNTRY = '' THEN 'NULL' ELSE C.COUNTRY END AS CUSTOMER_COUNTRY
, CASE WHEN V.COUNTRY = '' THEN 'NULL' ELSE V.COUNTRY END AS VENDOR_COUNTRY
, count(I.INVOICEHEADERID) AS HEADER_ID_COUNT
, I.AMOUNTCUSTOMER AS INVOICE_AMOUNT
  
FROM "BRONZE_CR"."CR_C7_PROD_CHROME_EXPENSE"."TBL_INVOICEHEADER" I
, "BRONZE_CR"."CR_C7_PROD_CHROME_EXPENSE"."TBL_INVOICEVENDORADDRESS" V
, "BRONZE_CR"."CR_C7_PROD_CHROME_EXPENSE"."TBL_CUSTOMERADDRESS" C

WHERE I.INVOICEVENDORADDRESSID = V.VENDORADDRESSID
AND I.CUSTOMERADDRESSID1 = C.CUSTOMERADDRESSID
AND I.INVOICEDATE>= $var_start_date and I.INVOICEDATE<= $var_end_date
--AND I.HEADERSTATUS <> 'DEL'
--"BRONZE_CE"AND C.STATUS <>'DEL'
AND I._FIVETRAN_DELETED ='FALSE' 
AND LOWER(C.CITY)  NOT LIKE '%test%'
--AND C.COUNTRY !='' 
--AND V.COUNTRY !=''

GROUP BY MONTH,I.INVOICEHEADERID,CUSTOMER_COUNTRY, VENDOR_COUNTRY,INVOICE_AMOUNT))
