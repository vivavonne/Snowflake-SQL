SET VAR_START_DATE ='01-JAN-2019';
SET VAR_END_DATE = '31-DEC-2021';

SELECT YEAR, TRANSACTIONTYPE,TRANSACTIONCOUNT,AVG(AVG_DATEF) FROM
((SELECT BU_REGION, YEAR,TRANSACTIONTYPE, SUM(TRANSACTIONCOUNT) AS TRANSACTIONCOUNT, AVG(DATEDIFF(DAY,CREATEDATE, SUBMITDATE) +1)  AS AVG_DATEF FROM 
((SELECT
  'US' AS BU_REGION
, YEAR (T.CREATEDATE) AS YEAR
, CASE WHEN F.FEEDTYPEID = 2 THEN 'PERSONAL CARD'
    WHEN T.TYPE = 'DEF' AND T.ISFIRMPAID = 1 THEN 'CORPORATE CARD'
        ELSE 'CASH ' END AS TRANSACTIONTYPE
--, CASE WHEN F.FEEDTYPEID IN (1,5,6) THEN 'CORPORATE CARD' 
--     WHEN F.FEEDTYPEID IN (2) THEN 'PERSONAL CARD' 
 --       WHEN F.FEEDTYPEID NOT IN (1,2,5,6) THEN 'OTHER'
 --           ELSE 'NULL' END AS CARD_TYPE
--, CD.STATUSIMPL AS C_STATUS
--, T.TYPE AS TRANSACTION_TYPE
, COUNT(T.EXPENSETRANSACTIONID) AS TRANSACTIONCOUNT
, MIN(L.CREATEDATE) AS CREATEDATE
, MAX(H.SUBMITDATE) AS SUBMITDATE
--, AVG (DATEDIFF(DAY,T.CREATEDATE, H.SUBMITDATE) +1)  AS DATE_DIFF

FROM "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTHEADER" H
, "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTLINEITEM" L
, "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_EXPENSETRANSACTION"  T 
, "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_FEED" F 
, "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_CUSTOMER" C
, "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_CUSTOMERDATA" CD
  
WHERE H.EXPENSEREPORTHEADERID = L.EXPENSEREPORTHEADERID
AND L.EXPENSETRANSACTIONID = T.EXPENSETRANSACTIONID
AND T.FEEDID = F.FEEDID 
AND T.CUSTOMERID = C.CUSTOMERID
AND C.CUSTOMERID = CD.CUSTOMERID
AND T.CREATEDATE>= $var_start_date and T.CREATEDATE<= $var_end_date
AND H._FIVETRAN_DELETED = 'FALSE' AND L._FIVETRAN_DELETED = 'FALSE' AND T._FIVETRAN_DELETED = 'FALSE'

GROUP BY YEAR,T.EXPENSETRANSACTIONID,TRANSACTIONTYPE
ORDER BY YEAR
)

UNION ALL 

(SELECT
  'US' AS BU_REGION
, YEAR (T.CREATEDATE) AS YEAR
, CASE WHEN F.FEEDTYPEID = 2 THEN 'PERSONAL CARD'
    WHEN T.TYPE = 'DEF' AND T.ISFIRMPAID = 1 THEN 'CORPORATE CARD'
        ELSE 'CASH ' END AS TRANSACTIONTYPE
--, CASE WHEN F.FEEDTYPEID IN (1,5,6) THEN 'CORPORATE CARD' 
--     WHEN F.FEEDTYPEID IN (2) THEN 'PERSONAL CARD' 
 --       WHEN F.FEEDTYPEID NOT IN (1,2,5,6) THEN 'OTHER'
 --           ELSE 'NULL' END AS CARD_TYPE
--, CD.STATUSIMPL AS C_STATUS
--, T.TYPE AS TRANSACTION_TYPE
, COUNT(T.EXPENSETRANSACTIONID) AS TRANSACTIONCOUNT
, MIN(L.CREATEDATE) AS CREATEDATE
, MAX(H.SUBMITDATE) AS SUBMITDATE
--, AVG (DATEDIFF(DAY,T.CREATEDATE, H.SUBMITDATE) +1)  AS DATE_DIFF

FROM "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTHEADER" H
, "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTLINEITEM" L
, "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_EXPENSETRANSACTION"  T 
, "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_FEED" F 
, "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_CUSTOMER" C
, "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_CUSTOMERDATA" CD
  
WHERE H.EXPENSEREPORTHEADERID = L.EXPENSEREPORTHEADERID
AND L.EXPENSETRANSACTIONID = T.EXPENSETRANSACTIONID
AND T.FEEDID = F.FEEDID 
AND T.CUSTOMERID = C.CUSTOMERID
AND C.CUSTOMERID = CD.CUSTOMERID
AND T.CREATEDATE>= $var_start_date and T.CREATEDATE<= $var_end_date
AND H._FIVETRAN_DELETED = 'FALSE' AND L._FIVETRAN_DELETED = 'FALSE' AND T._FIVETRAN_DELETED = 'FALSE'

GROUP BY YEAR,T.EXPENSETRANSACTIONID,TRANSACTIONTYPE
ORDER BY YEAR
)


UNION ALL 
 
(SELECT
  'US' AS BU_REGION
, YEAR (T.CREATEDATE) AS YEAR
, CASE WHEN F.FEEDTYPEID = 2 THEN 'PERSONAL CARD'
    WHEN T.TYPE = 'DEF' AND T.ISFIRMPAID = 1 THEN 'CORPORATE CARD'
        ELSE 'CASH ' END AS TRANSACTIONTYPE
--, CASE WHEN F.FEEDTYPEID IN (1,5,6) THEN 'CORPORATE CARD' 
--     WHEN F.FEEDTYPEID IN (2) THEN 'PERSONAL CARD' 
 --       WHEN F.FEEDTYPEID NOT IN (1,2,5,6) THEN 'OTHER'
 --           ELSE 'NULL' END AS CARD_TYPE
--, CD.STATUSIMPL AS C_STATUS
--, T.TYPE AS TRANSACTION_TYPE
, COUNT(T.EXPENSETRANSACTIONID) AS TRANSACTIONCOUNT
, MIN(L.CREATEDATE) AS CREATEDATE
, MAX(H.SUBMITDATE) AS SUBMITDATE
--, AVG (DATEDIFF(DAY,T.CREATEDATE, H.SUBMITDATE) +1)  AS DATE_DIFF

FROM "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTHEADER" H
, "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTLINEITEM" L
, "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_EXPENSETRANSACTION"  T 
, "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_FEED" F 
, "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_CUSTOMER" C
, "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_CUSTOMERDATA" CD
  
WHERE H.EXPENSEREPORTHEADERID = L.EXPENSEREPORTHEADERID
AND L.EXPENSETRANSACTIONID = T.EXPENSETRANSACTIONID
AND T.FEEDID = F.FEEDID 
AND T.CUSTOMERID = C.CUSTOMERID
AND C.CUSTOMERID = CD.CUSTOMERID
AND T.CREATEDATE>= $var_start_date and T.CREATEDATE<= $var_end_date
AND H._FIVETRAN_DELETED = 'FALSE' AND L._FIVETRAN_DELETED = 'FALSE' AND T._FIVETRAN_DELETED = 'FALSE'

GROUP BY YEAR,T.EXPENSETRANSACTIONID,TRANSACTIONTYPE
ORDER BY YEAR
))
GROUP BY BU_REGION,YEAR, TRANSACTIONTYPE
ORDER BY YEAR))
GROUP BY YEAR,TRANSACTIONTYPE,TRANSACTIONCOUNT
ORDER BY YEAR, TRANSACTIONTYPE
