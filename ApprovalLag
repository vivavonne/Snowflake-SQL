SET VAR_START_DATE ='01-JAN-2019';
SET VAR_END_DATE = '31-OCT-2021';

SELECT YEAR, AVG(DATE_DIFF) FROM 
((SELECT 
YEAR (S.CREATEDATE) AS YEAR
, AVG (DATEDIFF(DAY,S.CREATEDATE, S.UPDATEDATE) +1)  AS DATE_DIFF

FROM "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTHEADER" H
, "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTLINEITEM" L
, "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTLINEITEMSTEP" S

WHERE H.EXPENSEREPORTHEADERID = L.EXPENSEREPORTHEADERID
AND L.EXPENSEREPORTLINEITEMID = S.EXPENSEREPORTLINEITEMID
AND S.CREATEDATE>= $var_start_date and S.CREATEDATE<= $var_end_date
AND H._FIVETRAN_DELETED = 'FALSE' AND L._FIVETRAN_DELETED = 'FALSE' AND S._FIVETRAN_DELETED = 'FALSE'

GROUP BY YEAR
ORDER BY YEAR
)

UNION ALL

(SELECT 
YEAR (S.CREATEDATE) AS YEAR
, AVG (DATEDIFF(DAY,S.CREATEDATE, S.UPDATEDATE) +1)  AS DATE_DIFF

FROM "BRONZE_CR"."CR_C2_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTHEADER" H
, "BRONZE_CR"."CR_C2_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTLINEITEM" L
, "BRONZE_CR"."CR_C2_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTLINEITEMSTEP" S

WHERE H.EXPENSEREPORTHEADERID = L.EXPENSEREPORTHEADERID
AND L.EXPENSEREPORTLINEITEMID = S.EXPENSEREPORTLINEITEMID
AND S.CREATEDATE>= $var_start_date and S.CREATEDATE<= $var_end_date
AND H._FIVETRAN_DELETED = 'FALSE' AND L._FIVETRAN_DELETED = 'FALSE' AND S._FIVETRAN_DELETED = 'FALSE'

GROUP BY YEAR
ORDER BY YEAR
)

UNION ALL

(SELECT 
YEAR (S.CREATEDATE) AS YEAR
, AVG (DATEDIFF(DAY,S.CREATEDATE, S.UPDATEDATE) +1)  AS DATE_DIFF

FROM "BRONZE_CR"."CR_C7_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTHEADER" H
, "BRONZE_CR"."CR_C7_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTLINEITEM" L
, "BRONZE_CR"."CR_C7_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTLINEITEMSTEP" S

WHERE H.EXPENSEREPORTHEADERID = L.EXPENSEREPORTHEADERID
AND L.EXPENSEREPORTLINEITEMID = S.EXPENSEREPORTLINEITEMID
AND S.CREATEDATE>= $var_start_date and S.CREATEDATE<= $var_end_date
AND H._FIVETRAN_DELETED = 'FALSE' AND L._FIVETRAN_DELETED = 'FALSE' AND S._FIVETRAN_DELETED = 'FALSE'

GROUP BY YEAR
ORDER BY YEAR
))
GROUP BY YEAR
ORDER BY YEAR
