//Identify number of cutomers as well as if they are an admin and use the mobile app

SET VAR_START_DATE = '01-sep-2021';
SET VAR_END_DATE = getdate();

SELECT month, MOBILEUSE,ADMIN, COUNT(distinct(EMPID)) as count FROM

((select 
'C1' AS CLUSTER_LOCATION
, month(exp_date) as month
, P.EMP_USRFK AS EMPID
, CASE WHEN P.EMP_ADMIN = 'TRUE' THEN 'Y ' 
    WHEN P.EMP_ADMIN = 'FALSE' THEN 'N'
    ELSE 'OTHER' END AS ADMIN
, CASE WHEN R.RECEIPT_RECEIPTINPUTMETHODFK = '4' THEN 'Y'
    ELSE 'N' END AS MOBILEUSE
 , COUNT(E.EXP_EXPRPTFK)
from  "BRONZE_CE"."CE_PROD_01_DBO"."EXP" E 
JOIN "BRONZE_CE"."CE_PROD_01_DBO"."RECEIPT" R ON R.RECEIPT_PK = E.EXP_RECEIPTFK
JOIN "BRONZE_CE"."CE_PROD_01_DBO"."EMP" P ON P.EMP_PK = E.EXP_EMPFK
JOIN "BRONZE_CE"."CE_PROD_01_DBO"."EXPRPT" RR ON RR.EXPRPT_PK = E.EXP_EXPRPTFK
join "BRONZE_CE"."CE_PROD_01_DBO"."USR" u on u.usr_pk = p.EMP_USRFK

wherE  R._FIVETRAN_DELETED = FALSE AND E._FIVETRAN_DELETED= FALSE AND P._FIVETRAN_DELETED=FALSE AND RR._FIVETRAN_DELETED=FALSE 
AND EXP_DATE>= $var_start_date and EXP_DATE<= $var_end_date
and  P.EMP_PK  not in ('71966','71962','617327')
GROUP BY month, EMPID, ADMIN, MOBILEUSE)
 
UNION ALL
 
(select 
'C2' AS CLUSTER_LOCATION
, month(exp_date) as month
, P.EMP_USRFK AS EMPID
, CASE WHEN P.EMP_ADMIN = 'TRUE' THEN 'Y ' 
    WHEN P.EMP_ADMIN = 'FALSE' THEN 'N'
    ELSE 'OTHER' END AS ADMIN
, CASE WHEN R.RECEIPT_RECEIPTINPUTMETHODFK = '4' THEN 'Y'
    ELSE 'N' END AS MOBILEUSE
 , COUNT(E.EXP_EXPRPTFK)
from  "BRONZE_CE"."CE_PROD_02_DBO"."EXP" E 
JOIN "BRONZE_CE"."CE_PROD_02_DBO"."RECEIPT" R ON R.RECEIPT_PK = E.EXP_RECEIPTFK
JOIN "BRONZE_CE"."CE_PROD_02_DBO"."EMP" P ON P.EMP_PK = E.EXP_EMPFK
JOIN "BRONZE_CE"."CE_PROD_02_DBO"."EXPRPT" RR ON RR.EXPRPT_PK = E.EXP_EXPRPTFK
join "BRONZE_CE"."CE_PROD_02_DBO"."USR" u on u.usr_pk = p.EMP_USRFK

wherE  R._FIVETRAN_DELETED = FALSE AND E._FIVETRAN_DELETED= FALSE AND P._FIVETRAN_DELETED=FALSE AND RR._FIVETRAN_DELETED=FALSE 
AND EXP_DATE>= $var_start_date and EXP_DATE<= $var_end_date
and  P.EMP_PK  not in ('71966','71962','617327')
GROUP BY month, EMPID, ADMIN, MOBILEUSE)

UNION ALL
 
(select 
'C1' AS CLUSTER_LOCATION
, month(exp_date) as month
, P.EMP_USRFK AS EMPID
, CASE WHEN P.EMP_ADMIN = 'TRUE' THEN 'Y ' 
    WHEN P.EMP_ADMIN = 'FALSE' THEN 'N'
    ELSE 'OTHER' END AS ADMIN
, CASE WHEN R.RECEIPT_RECEIPTINPUTMETHODFK = '4' THEN 'Y'
    ELSE 'N' END AS MOBILEUSE
 , COUNT(E.EXP_EXPRPTFK)
from  "BRONZE_CE"."CE_PROD_03_DBO"."EXP" E 
JOIN "BRONZE_CE"."CE_PROD_03_DBO"."RECEIPT" R ON R.RECEIPT_PK = E.EXP_RECEIPTFK
JOIN "BRONZE_CE"."CE_PROD_03_DBO"."EMP" P ON P.EMP_PK = E.EXP_EMPFK
JOIN "BRONZE_CE"."CE_PROD_03_DBO"."EXPRPT" RR ON RR.EXPRPT_PK = E.EXP_EXPRPTFK
join "BRONZE_CE"."CE_PROD_03_DBO"."USR" u on u.usr_pk = p.EMP_USRFK

wherE  R._FIVETRAN_DELETED = FALSE AND E._FIVETRAN_DELETED= FALSE AND P._FIVETRAN_DELETED=FALSE AND RR._FIVETRAN_DELETED=FALSE 
AND EXP_DATE>= $var_start_date and EXP_DATE<= $var_end_date
and  P.EMP_PK  not in ('71966','71962','617327')
GROUP BY month, EMPID, ADMIN, MOBILEUSE)

UNION ALL

(select 
'C1' AS CLUSTER_LOCATION
, month(exp_date) as month
, P.EMP_USRFK AS EMPID
, CASE WHEN P.EMP_ADMIN = 'TRUE' THEN 'Y ' 
    WHEN P.EMP_ADMIN = 'FALSE' THEN 'N'
    ELSE 'OTHER' END AS ADMIN
, CASE WHEN R.RECEIPT_RECEIPTINPUTMETHODFK = '4' THEN 'Y'
    ELSE 'N' END AS MOBILEUSE
 , COUNT(E.EXP_EXPRPTFK)
from  "BRONZE_CE"."CE_PROD_04_DBO"."EXP" E 
JOIN "BRONZE_CE"."CE_PROD_04_DBO"."RECEIPT" R ON R.RECEIPT_PK = E.EXP_RECEIPTFK
JOIN "BRONZE_CE"."CE_PROD_04_DBO"."EMP" P ON P.EMP_PK = E.EXP_EMPFK
JOIN "BRONZE_CE"."CE_PROD_04_DBO"."EXPRPT" RR ON RR.EXPRPT_PK = E.EXP_EXPRPTFK
join "BRONZE_CE"."CE_PROD_04_DBO"."USR" u on u.usr_pk = p.EMP_USRFK

wherE  R._FIVETRAN_DELETED = FALSE AND E._FIVETRAN_DELETED= FALSE AND P._FIVETRAN_DELETED=FALSE AND RR._FIVETRAN_DELETED=FALSE 
AND EXP_DATE>= $var_start_date and EXP_DATE<= $var_end_date
and  P.EMP_PK  not in ('71966','71962','617327')
GROUP BY month, EMPID, ADMIN, MOBILEUSE))

GROUP BY month, mobileuse,admin

order by month
