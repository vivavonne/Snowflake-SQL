
select (count(Distinct(PersonID))) AS COUNT,CORPORATE_CARD,PERSONAL_CARD,OTHER_CARD from

((select
'C1' AS CLUSTER_LOCATION
, COUNT (H.EXPENSEREPORTHEADERID)
, CASE WHEN F.FEEDTYPEID IN (1,5,6) THEN 'CORPORATE CARD' ELSE 'NULL' END AS CORPORATE_CARD
, CASE WHEN F.FEEDTYPEID IN (2) THEN 'PERSONAL CARD' ELSE 'NULL' END AS PERSONAL_CARD
, CASE WHEN F.FEEDTYPEID NOT IN (1,2,5,6) THEN 'OTHER' ELSE 'NULL' END AS OTHER_CARD
, F.FEEDTYPEID
, H.PERSONID
, concat(P.FIRSTNAME,' ', P.LASTNAME) as CUSTOMER_NAME
, H.CUSTOMERID
, C.NAME
, H.SUBMITDATE
, MIN(L.TRANSACTIONDATE) as mindate
, DATEDIFF(DAYS,MIN(L.TRANSACTIONDATE),SUBMITDATE) AS DIFF
, COUNT(L.EXPENSEREPORTLINEITEMID) AS EXPENSECOUNT
from "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTHEADER" H
join "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_PERSON" P on P.PERSONID = H.PERSONID
join "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_CUSTOMER" C on C.CUSTOMERID = H.CUSTOMERID
join "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTLINEITEM" L ON L.EXPENSEREPORTHEADERID =H.EXPENSEREPORTHEADERID
JOIN "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_EXPENSETRANSACTION" T ON T. EXPENSETRANSACTIONID = L.EXPENSETRANSACTIONID
JOIN "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_FEED" F ON F.FEEDID = T.FEEDID
JOIN "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_FEEDTYPE" FT ON FT.FEEDTYPEID = F.FEEDTYPEID
 
where SUBMITDATE between (LAST_DAY(SUBMITDATE) - interval '3 day') and LAST_DAY(SUBMITDATE)
and YEAR(SUBMITDATE) =2019
and H._FIVETRAN_DELETED = FALSE and P._FIVETRAN_DELETED = FALSE and C._FIVETRAN_DELETED = FALSE AND L._FIVETRAN_DELETED = FALSE  
AND P.PERSONSTATUSID = 2
and h.STATUSID IN (3,5)
and P.PERSONID not in 
(select PERSONID from "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTHEADER" H 
 join "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTLINEITEM" L ON H.EXPENSEREPORTHEADERID = L.EXPENSEREPORTHEADERID
where 
SUBMITDATE not between (LAST_DAY(SUBMITDATE) - interval '3 day') and LAST_DAY(SUBMITDATE)
AND YEAR(SUBMITDATE) = 2019
group by H.CustomerID,H. PersonID, H.ExpenseReportHeaderID
order by H.CustomerID, H.PersonID, H.ExpenseReportHeaderID) 
group by H.CustomerID, H.PersonID, H.ExpenseReportHeaderID,P.FIRSTNAME, P.LASTNAME,C.NAME, H.SUBMITDATE, F.FEEDTYPEID HAVING EXPENSECOUNT>=3 AND DIFF>=25
order by H.CustomerID, H.PersonID, H.ExpenseReportHeaderID)

UNION ALL

(select
'C1' AS CLUSTER_LOCATION
, COUNT (H.EXPENSEREPORTHEADERID)
, CASE WHEN F.FEEDTYPEID IN (1,5,6) THEN 'CORPORATE CARD' ELSE 'NULL' END AS CORPORATE_CARD
, CASE WHEN F.FEEDTYPEID IN (2) THEN 'PERSONAL CARD' ELSE 'NULL' END AS PERSONAL_CARD
, CASE WHEN F.FEEDTYPEID NOT IN (1,2,5,6) THEN 'OTHER' ELSE 'NULL' END AS OTHER_CARD
, F.FEEDTYPEID
, H.PERSONID
, concat(P.FIRSTNAME,' ', P.LASTNAME) as CUSTOMER_NAME
, H.CUSTOMERID
, C.NAME
, H.SUBMITDATE
, MIN(L.TRANSACTIONDATE) as mindate
, DATEDIFF(DAYS,MIN(L.TRANSACTIONDATE),SUBMITDATE) AS DIFF
, COUNT(T.EXPENSETRANSACTIONID) AS EXPENSECOUNT
from "BRONZE_CR"."CR_C2_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTHEADER" H
join "BRONZE_CR"."CR_C2_PROD_CHROME_EXPENSE"."TBL_PERSON" P on P.PERSONID = H.PERSONID
join "BRONZE_CR"."CR_C2_PROD_CHROME_EXPENSE"."TBL_CUSTOMER" C on C.CUSTOMERID = H.CUSTOMERID
join "BRONZE_CR"."CR_C2_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTLINEITEM" L ON L.EXPENSEREPORTHEADERID =H.EXPENSEREPORTHEADERID
JOIN "BRONZE_CR"."CR_C2_PROD_CHROME_EXPENSE"."TBL_EXPENSETRANSACTION" T ON T. EXPENSETRANSACTIONID = L.EXPENSETRANSACTIONID
JOIN "BRONZE_CR"."CR_C2_PROD_CHROME_EXPENSE"."TBL_FEED" F ON F.FEEDID = T.FEEDID
JOIN "BRONZE_CR"."CR_C2_PROD_CHROME_EXPENSE"."TBL_FEEDTYPE" FT ON FT.FEEDTYPEID = F.FEEDTYPEID
 
where SUBMITDATE between (LAST_DAY(SUBMITDATE) - interval '3 day') and LAST_DAY(SUBMITDATE)
and YEAR(SUBMITDATE) =2019
and H._FIVETRAN_DELETED = FALSE and P._FIVETRAN_DELETED = FALSE and C._FIVETRAN_DELETED = FALSE AND L._FIVETRAN_DELETED = FALSE  
AND P.PERSONSTATUSID = 2
and h.STATUSID IN (3,5)
and P.PERSONID not in 
(select PERSONID from "BRONZE_CR"."CR_C2_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTHEADER" H 
 join "BRONZE_CR"."CR_C2_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTLINEITEM" L ON H.EXPENSEREPORTHEADERID = L.EXPENSEREPORTHEADERID
where 
SUBMITDATE not between (LAST_DAY(SUBMITDATE) - interval '3 day') and LAST_DAY(SUBMITDATE)
AND YEAR(SUBMITDATE) = 2019
group by H.CustomerID,H. PersonID, H.ExpenseReportHeaderID
order by H.CustomerID, H.PersonID, H.ExpenseReportHeaderID) 
group by H.CustomerID, H.PersonID, H.ExpenseReportHeaderID,P.FIRSTNAME, P.LASTNAME,C.NAME, H.SUBMITDATE, F.FEEDTYPEID HAVING EXPENSECOUNT>=3 AND DIFF>=25
order by H.CustomerID, H.PersonID, H.ExpenseReportHeaderID)
 
UNION ALL
 
(select
'C1' AS CLUSTER_LOCATION
, COUNT (H.EXPENSEREPORTHEADERID)
, CASE WHEN F.FEEDTYPEID IN (1,5,6) THEN 'CORPORATE CARD' ELSE 'NULL' END AS CORPORATE_CARD
, CASE WHEN F.FEEDTYPEID IN (2) THEN 'PERSONAL CARD' ELSE 'NULL' END AS PERSONAL_CARD
, CASE WHEN F.FEEDTYPEID NOT IN (1,2,5,6) THEN 'OTHER' ELSE 'NULL' END AS OTHER_CARD
, F.FEEDTYPEID
, H.PERSONID
, concat(P.FIRSTNAME,' ', P.LASTNAME) as CUSTOMER_NAME
, H.CUSTOMERID
, C.NAME
, H.SUBMITDATE
, MIN(L.TRANSACTIONDATE) as mindate
, DATEDIFF(DAYS,MIN(L.TRANSACTIONDATE),SUBMITDATE) AS DIFF
, COUNT(L.EXPENSEREPORTLINEITEMID) AS EXPENSECOUNT
from "BRONZE_CR"."CR_C7_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTHEADER" H
join "BRONZE_CR"."CR_C7_PROD_CHROME_EXPENSE"."TBL_PERSON" P on P.PERSONID = H.PERSONID
join "BRONZE_CR"."CR_C7_PROD_CHROME_EXPENSE"."TBL_CUSTOMER" C on C.CUSTOMERID = H.CUSTOMERID
join "BRONZE_CR"."CR_C7_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTLINEITEM" L ON L.EXPENSEREPORTHEADERID =H.EXPENSEREPORTHEADERID
JOIN "BRONZE_CR"."CR_C7_PROD_CHROME_EXPENSE"."TBL_EXPENSETRANSACTION" T ON T. EXPENSETRANSACTIONID = L.EXPENSETRANSACTIONID
JOIN "BRONZE_CR"."CR_C7_PROD_CHROME_EXPENSE"."TBL_FEED" F ON F.FEEDID = T.FEEDID
JOIN "BRONZE_CR"."CR_C7_PROD_CHROME_EXPENSE"."TBL_FEEDTYPE" FT ON FT.FEEDTYPEID = F.FEEDTYPEID
 
where SUBMITDATE between (LAST_DAY(SUBMITDATE) - interval '3 day') and LAST_DAY(SUBMITDATE)
and YEAR(SUBMITDATE) =2019
and H._FIVETRAN_DELETED = FALSE and P._FIVETRAN_DELETED = FALSE and C._FIVETRAN_DELETED = FALSE AND L._FIVETRAN_DELETED = FALSE  
AND P.PERSONSTATUSID = 2
and h.STATUSID IN (3,5)
and P.PERSONID not in 
(select PERSONID from "BRONZE_CR"."CR_C7_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTHEADER" H 
 join "BRONZE_CR"."CR_C7_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTLINEITEM" L ON H.EXPENSEREPORTHEADERID = L.EXPENSEREPORTHEADERID
where 
SUBMITDATE not between (LAST_DAY(SUBMITDATE) - interval '3 day') and LAST_DAY(SUBMITDATE)
AND YEAR(SUBMITDATE) = 2019
group by H.CustomerID,H. PersonID, H.ExpenseReportHeaderID
order by H.CustomerID, H.PersonID, H.ExpenseReportHeaderID) 
group by H.CustomerID, H.PersonID, H.ExpenseReportHeaderID,P.FIRSTNAME, P.LASTNAME,C.NAME, H.SUBMITDATE, F.FEEDTYPEID HAVING EXPENSECOUNT>=3 AND DIFF>=25
order by H.CustomerID, H.PersonID, H.ExpenseReportHeaderID))
GROUP BY CORPORATE_CARD,PERSONAL_CARD,OTHER_CARD
