SET (FROMDATE, TODATE) = ('2021-05-01', '2021-12-31');

SELECT 'US' AS REGION,CREATEMONTH AS MONTHNAME, SUM(EXPENSEREPORTS) AS REPORTS, NEWCUSTOMER FROM 
((SELECT DATE_TRUNC('MONTH',h.CreateDate) AS CreateMonth, 
COUNT(DISTINCT h.ExpenseReportHeaderID) as ExpenseReports, 
 CASE WHEN h.CustomerID IN (2442,2325,2157,2360,2324,2379,2332,2259,2398,2248,2303,2373,2148, 2151,2295,2330,2242,2080,2383,2224,871,2130,2409,2513,2293,2223,572,2188,
                            2444,2350,2381, 832, 2313, 2387, 2388, 2341, 2365, 2203, 387, 2414, 2392, 877, 2302, 2404, 2135, 2316, 2455, 2274, 2140, 2459, 2270, 2524, 
                            2405, 2395, 2534, 2509, 2347, 2377, 526, 2506, 2380, 2511, 2089, 2335, 2432, 2143, 2428, 2238, 2207, 2296, 2235, 2277, 2407, 2322, 2110, 2528, 
                            2254, 2370, 758, 2376, 2458, 2397, 2204, 2400, 825, 2257, 2273, 2452, 2088, 2020, 2305, 2320, 2514, 2354, 2382, 2451, 2247, 2344, 2426, 2131, 2399, 
                            2319, 2393, 2425, 2500, 2343, 2038, 706, 2150, 2411, 2339, 2299, 2429, 2304, 2531, 2357, 2449, 2361, 2265, 2363, 2406, 2519, 2562, 2408, 2541, 2087, 
                            2441, 2561, 2547, 2502, 2579, 2566, 2564, 2374, 2537, 2539, 2448, 2290, 2515, 2552, 2292, 2504, 2185, 2283, 2588, 2518, 2516, 2523, 2390, 2543, 2279, 
                            2456, 2074, 2527, 2437, 2453, 2572, 2553, 2423, 2369, 2505, 2501, 999, 861, 2549, 2424, 2554, 2571, 2419, 2371, 2364, 2589, 2263, 2508, 2337, 2611, 2598,
                            2355, 2199, 2558, 2584, 2310, 2099, 2359, 2545, 2620, 2430, 2450, 2104, 2418, 2417, 2507, 2436, 2536, 2260, 2573, 2520, 2597, 2613, 269, 2415, 2275, 2454,
                            2593, 2525, 2557, 2750, 2440, 2577, 2389, 2570, 2641, 2510, 2195, 2655, 2288, 2649, 2375, 2391, 2446, 2266, 2625, 2596, 2538, 2422, 2623, 2555, 2551, 2372,
                            2627, 2600, 2583, 2621, 2626, 2635, 2602, 2556, 2658, 2580, 2661, 2648, 2582, 2592, 2595, 2533, 2634, 2067, 2646, 2457, 2348, 2546, 2607, 2386, 2656, 2618,
                            2652, 2616, 2007, 2680, 2567, 2550, 2672, 2610, 2587, 2351, 2521, 2540, 2591, 2637, 2264, 2285, 2565, 2614, 2612, 2692, 2708, 2701, 2636, 2434, 2599, 2163,
                            2532, 2180, 2609, 2682, 2301, 2594, 2606, 2670, 2396, 2548, 2601, 2431, 2633, 2711, 2590, 2568, 2654, 2687, 2650, 2443, 2697, 2276, 2640, 2676, 2439, 2706,
                            2657, 2663, 2746, 2664, 2693, 2748, 2608, 2681, 2683, 2574, 2730, 2752, 2734, 2751, 2675, 2685, 2733, 2674, 2560, 2725, 2757, 2698, 2728, 2729, 2758, 2722,
                            2578, 2699, 2704, 2749, 2740, 2221, 2639, 2784, 2696, 2718, 2738, 2745, 2780, 2774, 2800, 325) THEN 'Yes' ELSE 'No' END AS NewCustomer 
 FROM "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTHEADER" h 
 JOIN "BRONZE_CR"."CR_C1_PROD_CHROME_EXPENSE"."TBL_CUSTOMERDATA" cd USING(CustomerID) 
 WHERE h.CreateDate >= $FROMDATE AND h.CreateDate <= $TODATE AND NOT h.StatusID in (1, 4) 
 AND cd.IsExpenseLive = 1 
 AND h.CustomerID > 9 
 AND h.CustomerID NOT IN (154, 239) 
 AND h.CustomerID not between 900 AND 1999 
 AND h._fivetran_deleted = FALSE
 GROUP BY  CreateMonth, NewCustomer 
 ORDER BY CreateMonth, NewCustomer)
 
 union all
 
 (SELECT DATE_TRUNC('MONTH',h.CreateDate) AS CreateMonth, 

 COUNT(DISTINCT h.ExpenseReportHeaderID) as ExpenseReports, 
 CASE WHEN h.CustomerID IN (2442,2325,2157,2360,2324,2379,2332,2259,2398,2248,2303,2373,2148, 2151,2295,2330,2242,2080,2383,2224,871,2130,2409,2513,2293,2223,572,2188,
                            2444,2350,2381, 832, 2313, 2387, 2388, 2341, 2365, 2203, 387, 2414, 2392, 877, 2302, 2404, 2135, 2316, 2455, 2274, 2140, 2459, 2270, 2524, 
                            2405, 2395, 2534, 2509, 2347, 2377, 526, 2506, 2380, 2511, 2089, 2335, 2432, 2143, 2428, 2238, 2207, 2296, 2235, 2277, 2407, 2322, 2110, 2528, 
                            2254, 2370, 758, 2376, 2458, 2397, 2204, 2400, 825, 2257, 2273, 2452, 2088, 2020, 2305, 2320, 2514, 2354, 2382, 2451, 2247, 2344, 2426, 2131, 2399, 
                            2319, 2393, 2425, 2500, 2343, 2038, 706, 2150, 2411, 2339, 2299, 2429, 2304, 2531, 2357, 2449, 2361, 2265, 2363, 2406, 2519, 2562, 2408, 2541, 2087, 
                            2441, 2561, 2547, 2502, 2579, 2566, 2564, 2374, 2537, 2539, 2448, 2290, 2515, 2552, 2292, 2504, 2185, 2283, 2588, 2518, 2516, 2523, 2390, 2543, 2279, 
                            2456, 2074, 2527, 2437, 2453, 2572, 2553, 2423, 2369, 2505, 2501, 999, 861, 2549, 2424, 2554, 2571, 2419, 2371, 2364, 2589, 2263, 2508, 2337, 2611, 2598,
                            2355, 2199, 2558, 2584, 2310, 2099, 2359, 2545, 2620, 2430, 2450, 2104, 2418, 2417, 2507, 2436, 2536, 2260, 2573, 2520, 2597, 2613, 269, 2415, 2275, 2454,
                            2593, 2525, 2557, 2750, 2440, 2577, 2389, 2570, 2641, 2510, 2195, 2655, 2288, 2649, 2375, 2391, 2446, 2266, 2625, 2596, 2538, 2422, 2623, 2555, 2551, 2372,
                            2627, 2600, 2583, 2621, 2626, 2635, 2602, 2556, 2658, 2580, 2661, 2648, 2582, 2592, 2595, 2533, 2634, 2067, 2646, 2457, 2348, 2546, 2607, 2386, 2656, 2618,
                            2652, 2616, 2007, 2680, 2567, 2550, 2672, 2610, 2587, 2351, 2521, 2540, 2591, 2637, 2264, 2285, 2565, 2614, 2612, 2692, 2708, 2701, 2636, 2434, 2599, 2163,
                            2532, 2180, 2609, 2682, 2301, 2594, 2606, 2670, 2396, 2548, 2601, 2431, 2633, 2711, 2590, 2568, 2654, 2687, 2650, 2443, 2697, 2276, 2640, 2676, 2439, 2706,
                            2657, 2663, 2746, 2664, 2693, 2748, 2608, 2681, 2683, 2574, 2730, 2752, 2734, 2751, 2675, 2685, 2733, 2674, 2560, 2725, 2757, 2698, 2728, 2729, 2758, 2722,
                            2578, 2699, 2704, 2749, 2740, 2221, 2639, 2784, 2696, 2718, 2738, 2745, 2780, 2774, 2800, 325) THEN 'Yes' ELSE 'No' END AS NewCustomer 
 FROM "BRONZE_CR"."CR_C2_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTHEADER" h 
 JOIN "BRONZE_CR"."CR_C2_PROD_CHROME_EXPENSE"."TBL_CUSTOMERDATA" cd USING(CustomerID) 
 WHERE h.CreateDate >= $FROMDATE AND h.CreateDate <= $TODATE AND NOT h.StatusID in (1, 4) 
 AND cd.IsExpenseLive = 1 
 AND h.CustomerID > 9 
 AND h.CustomerID NOT IN (154, 239) 
 AND h.CustomerID not between 900 AND 1999 
 AND h._fivetran_deleted = FALSE
  GROUP BY  CreateMonth, NewCustomer 
 ORDER BY CreateMonth, NewCustomer)
 
 union all
 
 (SELECT DATE_TRUNC('MONTH',h.CreateDate) AS CreateMonth, 

 COUNT(DISTINCT h.ExpenseReportHeaderID) as ExpenseReports, 
 CASE WHEN h.CustomerID IN (2442,2325,2157,2360,2324,2379,2332,2259,2398,2248,2303,2373,2148, 2151,2295,2330,2242,2080,2383,2224,871,2130,2409,2513,2293,2223,572,2188,
                            2444,2350,2381, 832, 2313, 2387, 2388, 2341, 2365, 2203, 387, 2414, 2392, 877, 2302, 2404, 2135, 2316, 2455, 2274, 2140, 2459, 2270, 2524, 
                            2405, 2395, 2534, 2509, 2347, 2377, 526, 2506, 2380, 2511, 2089, 2335, 2432, 2143, 2428, 2238, 2207, 2296, 2235, 2277, 2407, 2322, 2110, 2528, 
                            2254, 2370, 758, 2376, 2458, 2397, 2204, 2400, 825, 2257, 2273, 2452, 2088, 2020, 2305, 2320, 2514, 2354, 2382, 2451, 2247, 2344, 2426, 2131, 2399, 
                            2319, 2393, 2425, 2500, 2343, 2038, 706, 2150, 2411, 2339, 2299, 2429, 2304, 2531, 2357, 2449, 2361, 2265, 2363, 2406, 2519, 2562, 2408, 2541, 2087, 
                            2441, 2561, 2547, 2502, 2579, 2566, 2564, 2374, 2537, 2539, 2448, 2290, 2515, 2552, 2292, 2504, 2185, 2283, 2588, 2518, 2516, 2523, 2390, 2543, 2279, 
                            2456, 2074, 2527, 2437, 2453, 2572, 2553, 2423, 2369, 2505, 2501, 999, 861, 2549, 2424, 2554, 2571, 2419, 2371, 2364, 2589, 2263, 2508, 2337, 2611, 2598,
                            2355, 2199, 2558, 2584, 2310, 2099, 2359, 2545, 2620, 2430, 2450, 2104, 2418, 2417, 2507, 2436, 2536, 2260, 2573, 2520, 2597, 2613, 269, 2415, 2275, 2454,
                            2593, 2525, 2557, 2750, 2440, 2577, 2389, 2570, 2641, 2510, 2195, 2655, 2288, 2649, 2375, 2391, 2446, 2266, 2625, 2596, 2538, 2422, 2623, 2555, 2551, 2372,
                            2627, 2600, 2583, 2621, 2626, 2635, 2602, 2556, 2658, 2580, 2661, 2648, 2582, 2592, 2595, 2533, 2634, 2067, 2646, 2457, 2348, 2546, 2607, 2386, 2656, 2618,
                            2652, 2616, 2007, 2680, 2567, 2550, 2672, 2610, 2587, 2351, 2521, 2540, 2591, 2637, 2264, 2285, 2565, 2614, 2612, 2692, 2708, 2701, 2636, 2434, 2599, 2163,
                            2532, 2180, 2609, 2682, 2301, 2594, 2606, 2670, 2396, 2548, 2601, 2431, 2633, 2711, 2590, 2568, 2654, 2687, 2650, 2443, 2697, 2276, 2640, 2676, 2439, 2706,
                            2657, 2663, 2746, 2664, 2693, 2748, 2608, 2681, 2683, 2574, 2730, 2752, 2734, 2751, 2675, 2685, 2733, 2674, 2560, 2725, 2757, 2698, 2728, 2729, 2758, 2722,
                            2578, 2699, 2704, 2749, 2740, 2221, 2639, 2784, 2696, 2718, 2738, 2745, 2780, 2774, 2800, 325) THEN 'Yes' ELSE 'No' END AS NewCustomer 
 FROM "BRONZE_CR"."CR_C7_PROD_CHROME_EXPENSE"."TBL_EXPENSEREPORTHEADER" h 
 JOIN "BRONZE_CR"."CR_C7_PROD_CHROME_EXPENSE"."TBL_CUSTOMERDATA" cd USING(CustomerID) 
 WHERE h.CreateDate >= $FROMDATE AND h.CreateDate <= $TODATE AND NOT h.StatusID in (1, 4) 
 AND cd.IsExpenseLive = 1 
 AND h.CustomerID > 9 
 AND h.CustomerID NOT IN (154, 239) 
 AND h.CustomerID not between 900 AND 1999 
 AND h._fivetran_deleted = FALSE
 GROUP BY  CreateMonth, NewCustomer 
 ORDER BY CreateMonth, NewCustomer))
 
 GROUP BY  CreateMonth, NewCustomer 
 ORDER BY CreateMonth, NewCustomer
 
 
